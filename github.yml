test:
  runs-on: windows-latest
  timeout-minutes: 300

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show working directory
      run: pwd

    - name: Clear npm and Playwright cache
      shell: pwsh
      run: |
        npm cache clean --force
        Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:USERPROFILE\\AppData\\Local\\ms-playwright" -ErrorAction SilentlyContinue

    - name: Install dependencies
      run: |
        npm install
        npm i -D @playwright/test allure-playwright

    - name: Install Playwright Browsers
      run: npx playwright install

    - name: Run Playwright Tests
      run: npx playwright test

    - name: Generate Allure Report
      run: npx allure generate allure-results -o test-results/allure-report

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-reports-${{ github.job }}-${{ github.sha }}
        path: |
          test-results/
          *.log
        retention-days: 14

    - name: Upload JUnit XML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit-report
        path: test-results/junit.xml
