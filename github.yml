stage: test
script:
  - pwd
  # Clear npm and Playwright cache
  - npm cache clean --force
  # Clear any existing node_modules
  - rm -rf node_modules
  # Clear Playwright cache
  - rm -rf ~/.cache/ms-playwright
  # Install dependencies
  - npm install
  - npm i -D @playwright/test allure-playwright
  # Run tests
  - xvfb-run --auto-servernum npm run test:multi stg parallel 6
  # Generate Allure report
  - npx allure generate allure-results -o test-results/allure-report
timeout: 5h
artifacts:
  when: always
  name: "playwright-reports-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
  expire_in: 2 weeks
  paths:
    - test-results/
    - "*.log"
  exclude:
    - test-results/videos/          # Exclude large files
    - test-results/screenshots/     # Optional
reports:
  junit: test-results/junit.xml